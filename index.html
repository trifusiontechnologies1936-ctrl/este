<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Trifusion ‚Äì Cotizador & Facturaci√≥n</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Opcional: tu CSS externo -->
  <link rel="stylesheet" href="style.css">

  <style>
    body{
      background:#020617;
      color:#e5e7eb;
      margin:0;
      padding:16px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    .layout{
      display:flex;
      gap:16px;
      align-items:flex-start;
      max-width:1200px;
      margin:0 auto;
    }

    /* SIDEBAR */
    .sidebar{
      width:320px;
      background:linear-gradient(180deg,#064e3b,#020617);
      border-radius:20px;
      padding:16px;
      box-shadow:0 18px 45px rgba(0,0,0,0.7);
      border:1px solid #0d9488;
      position:sticky;
      top:16px;
    }

    .sidebar-section{
      background:rgba(15,23,42,0.85);
      border-radius:14px;
      border:1px solid rgba(148,163,184,.5);
      padding:12px;
      margin-top:12px;
    }

    .sidebar input,
    .sidebar textarea,
    .sidebar select{
      width:100%;
      padding:7px 9px;
      margin-top:3px;
      border-radius:10px;
      border:1px solid #1e293b;
      background:#020617;
      color:#e5e7eb;
    }

    /* MAIN */
    .main{
      flex:1;
      background:#020617;
      border-radius:20px;
      border:1px solid rgba(148,163,184,.5);
      box-shadow:0 18px 40px rgba(0,0,0,0.65);
      padding:16px;
    }

    .card{
      background:#020617;
      border-radius:14px;
      border:1px solid #1f2937;
      padding:12px;
      margin-bottom:12px;
    }

    .card input,
    .card textarea,
    .card select{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#020617;
      color:#e5e7eb;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:13px;
      cursor:pointer;
      background:#10b981;
      color:#022c22;
    }

    .btn-secondary{
      border:1px solid #374151;
      border-radius:999px;
      padding:7px 14px;
      font-size:13px;
      cursor:pointer;
      background:#111827;
      color:#e5e7eb;
    }

    .btn-danger{
      border:1px solid #fecaca;
      border-radius:999px;
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
      background:#7f1d1d;
      color:#fecaca;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }

    th, td{
      padding:6px;
      border-bottom:1px solid #111827;
      text-align:left;
    }

    .text-right{text-align:right;}
    .text-center{text-align:center;}

    #logoFactura,#logoPreview{
      max-height:70px;
      max-width:140px;
      object-fit:contain;
      border-radius:8px;
      background:#020617;
      padding:4px;
      border:1px solid #1f2937;
      display:none;
    }

    /* IMPRESI√ìN */
    @media print{
      @page{
        size: 8.5in 11in;
        margin: 10mm;
      }

      body{
        background:#fff !important;
        color:#000 !important;
      }

      .sidebar{
        display:none !important;
      }

      .main{
        background:#fff !important;
        border:none !important;
        box-shadow:none !important;
        color:#000 !important;
      }

      .card{
        background:#fff !important;
        border:1px solid #ccc !important;
      }

      table tr:nth-child(even){
        background:#fff !important;
      }

      .btn, .btn-secondary, .btn-danger{
        display:none !important;
      }
    }
  @page{
  margin:0;
}

@media print{
  a[href]:after{
    content:"" !important;
  }
}

  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
<div class="layout">

<!-- ====================== SIDEBAR ====================== -->
<aside class="sidebar">

  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1>
        <span style="display:inline-block;width:18px;height:18px;border-radius:8px;background:#10b981;"></span>
        Trifusion
      </h1>
      <div class="brand-badge">Technologies ‚Äî Panel</div>
    </div>
    <div class="small" style="text-align:right;">
      Usuario:<br>
      <span id="adminUserLabel" style="color:#bbf7d0;">Invitado</span>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginSection" class="sidebar-section">
    <h3 style="margin-top:0;">Iniciar sesi√≥n</h3>

    <label for="username">Correo administrador</label>
    <input id="username" type="email" placeholder="tu-correo-admin">

    <label for="password">Contrase√±a</label>
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

    <button class="btn" style="margin-top:8px;width:100%;" onclick="login()">
      Entrar
    </button>
  </div>

  <!-- PANEL ADMIN -->
  <div id="adminSection" style="display:none;">

    <!-- Sesi√≥n activa -->
    <div class="sidebar-section">
      <h3 style="margin-top:0;">Sesi√≥n activa</h3>
      <p class="small">Puedes administrar tienda, productos, Excel y ver cotizaciones.</p>
      <button class="btn-secondary" style="width:100%;" onclick="logout()">Cerrar sesi√≥n</button>
    </div>

    <!-- Datos tienda -->
    <div class="sidebar-section">
      <h3 style="margin-top:0;">Datos de la tienda</h3>

      <label>Nombre tienda</label>
      <input id="storeNameInput" type="text" placeholder="Trifusion Technologies">

      <label>Tel√©fono / WhatsApp</label>
      <input id="storePhoneInput" type="text" placeholder="829-872-5163">

      <label>Direcci√≥n</label>
      <input id="storeAddressInput" type="text" placeholder="Autopista de San Isidro">

      <label>Logo (imagen)</label>
      <input id="logoInput" type="file" accept="image/*" onchange="handleLogoUpload(event)">
      <img id="logoPreview">

      <button class="btn" style="margin-top:8px;width:100%;" onclick="guardarSettings()">
        Guardar tienda
      </button>
    </div>

    <!-- Productos -->
    <div class="sidebar-section">
      <h3 style="margin-top:0;">Productos</h3>

      <label>C√≥digo (opcional)</label>
      <input id="codigoProducto">

      <label>Nombre</label>
      <input id="nombreProducto">

      <label>Precio (RD$)</label>
      <input id="precioProducto" type="number" step="0.01">

      <label>Descripci√≥n</label>
      <input id="descripcionProducto">

      <button class="btn" style="margin-top:8px;width:100%;" onclick="crearProducto()">
        Agregar producto
      </button>
    </div>

    <!-- Masivo Excel -->
    <div class="sidebar-section">
      <h3 style="margin-top:0;">Carga masiva (Excel)</h3>

      <p class="small">
        Columnas: <strong>nombre</strong>, <strong>precio</strong>,
        <strong>descripcion</strong>, opcional <strong>codigo</strong>.
      </p>

      <input id="excelInput" type="file" accept=".xlsx" onchange="procesarExcel(event)">
      <p id="excelStatus" class="small" style="margin-top:6px;color:#67e8f9;"></p>
    </div>

    <!-- Lista productos -->
    <div class="sidebar-section">
      <h3 style="margin-top:0;">Productos cargados</h3>

      <div style="max-height:180px;overflow:auto;border-radius:10px;border:1px solid #111827;">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th class="text-right">Precio</th>
              <th class="text-center">C√≥digo</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tablaProductos"></tbody>
        </table>
      </div>
    </div>

    <!-- Cotizaciones recientes -->
    <div class="sidebar-section">
      <h3 style="margin-top:0;">Cotizaciones / Facturas recientes</h3>

      <div style="max-height:180px;overflow:auto;border-radius:10px;border:1px solid #111827;">
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Tipo</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody id="tablaQuotes"></tbody>
        </table>
      </div>
    </div>

  </div> <!-- FIN ADMIN -->
</aside>

<!-- ====================== MAIN ====================== -->
<main class="main">

  
<!-- ================= BUSCADOR GLOBAL ================= -->
<div class="card" style="margin-bottom:16px;">
  <input 
    type="text" 
    id="buscadorGlobal"
    placeholder="Buscar producto por nombre, marca o modelo‚Ä¶"
    style="width:100%;padding:10px;border-radius:10px;border:1px solid #1f2937;background:#020617;color:#e5e7eb;">

  <div id="resultadosBusqueda"
       style="display:none;max-height:250px;overflow-y:auto;border-radius:10px;border:1px solid #1f2937;background:#020617;margin-top:6px;">
  </div>
</div>

<!-- Encabezado factura -->
  <div class="card">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;">

      <div style="display:flex;gap:10px;align-items:center;">
        <img id="logoFactura">
        <div>
          <h1 id="storeNameDisplay" style="margin:0;font-size:22px;">Trifusion Technologies</h1>
          <div class="small">
            WhatsApp: <span id="storePhoneDisplay">829-872-5163</span><br>
            <span id="storeAddressDisplay">Autopista de San Isidro</span>
          </div>
        </div>
      </div>

      <div class="small" style="text-align:right;">
        <div id="modoTexto" style="font-weight:600;color:#10b981;">COTIZACI√ìN</div>
      </div>

    </div>
  </div>

  <!-- Datos del cliente -->
  <div class="card">
    <h2 id="tituloDocumento" style="margin-top:0;">Cotizaci√≥n</h2>

    <!-- Secci√≥n factura para admin -->
    <div id="facturaInfo" style="display:none;margin-bottom:12px;">
      <div class="card" style="background:rgba(16,185,129,0.08);border-color:#10b981;">
        <div class="row">
          <div>
            <label>N√∫mero de factura</label>
            <input id="facturaNumero" type="text" readonly style="font-weight:600;color:#10b981;">
          </div>

          <div>
            <label>M√©todo de pago</label>
            <select id="metodoPago">
              <option value="EFECTIVO">Efectivo</option>
              <option value="TRANSFERENCIA">Transferencia</option>
              <option value="TARJETA">Tarjeta</option>
              <option value="CREDITO">Cr√©dito a cliente</option>
            </select>
          </div>
        </div>

        <label>Nota interna</label>
        <textarea id="notaInterna" rows="2"></textarea>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Cliente</label>
        <input id="clienteNombre" type="text">
      </div>

      <div>
        <label>Documento</label>
        <input id="clienteDocumento" type="text" placeholder="RNC / C√©dula">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Tel√©fono</label>
        <input id="clienteTelefono" type="text">
      </div>

      <div>
        <label>Direcci√≥n</label>
        <input id="clienteDireccion" type="text">
      </div>

      <div style="max-width:170px;">
        <label>Fecha</label>
        <input id="fechaFactura" type="date">
      </div>
    </div>
  </div>

  <!-- Selecci√≥n de productos -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
      <h3 style="margin:0;">Productos</h3>

      <label style="font-size:12px;display:flex;align-items:center;gap:4px;color:#9ca3af;">
        <input type="checkbox" id="aplicarItbis" checked style="width:auto;">
        Aplicar ITBIS 18%
      </label>
    </div>

    <div class="row" style="margin-top:8px;">
      <div>
        <label>Producto</label>
        <select id="productoSeleccionado">
          <option value="">-- Selecciona un producto --</option>
        </select>
      </div>

      <div style="max-width:140px;">
        <label>Cantidad</label>
        <input id="cantidadProducto" type="number" min="1" value="1">
      </div>

      <div style="max-width:160px;align-self:flex-end;">
        <button class="btn" style="width:100%;" onclick="agregarALaFactura()">
          Agregar
        </button>
      </div>
    </div>
  </div>

  <!-- Detalle de productos -->
  <div class="card">
    <h3 style="margin-top:0;">Detalle</h3>

    <div style="max-height:260px;overflow:auto;border-radius:12px;border:1px solid #111827;">
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th class="text-center">Cant.</th>
            <th class="text-right">Precio</th>
            <th class="text-right">Importe</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tablaFactura"></tbody>
      </table>
    </div>

    <div style="margin-top:10px;font-size:14px;">
      <div class="text-right">Subtotal: <span id="subtotalFactura">RD$ 0.00</span></div>
      <div class="text-right">ITBIS: <span id="itbisFactura">RD$ 0.00</span></div>
      <div class="text-right">Env√≠o: <span id="totalEnvio">RD$ 0.00</span></div>
      <div class="text-right" style="font-weight:600;color:#10b981;">Total: <span id="totalFactura">RD$ 0.00</span></div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;">
      <button class="btn-secondary" onclick="nuevaFactura()">Nueva</button>
      <button class="btn-secondary" id="btnGuardar" onclick="guardarEnFirestore()">Guardar cotizaci√≥n</button>
      <button class="btn" onclick="window.print()">Imprimir / PDF</button>
    </div>
  </div>

  <!-- ============================
       C√ÅLCULO DE ENV√çO AUTOM√ÅTICO
       ============================ -->
  <div class="card">
    <h3 style="margin-top:0;">Costo de env√≠o (ubicaci√≥n autom√°tica)</h3>

    <button onclick="compartirUbicacion()" class="btn" style="margin-top:10px;">
      üìç Compartir ubicaci√≥n actual
    </button>

    <p id="estadoEnvio" class="small" style="margin-top:10px;color:#38bdf8;">
      Esperando ubicaci√≥n...
    </p>

    <div style="margin-top:10px;font-size:14px;">
      <div class="text-right">Env√≠o calculado: <span id="totalEnvioDetalle">RD$ 0.00</span></div>
    </div>
  </div>

</main>
</div> <!-- layout -->

<!-- ========================= FIREBASE ========================= -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<!-- Archivo con tus llaves reales -->
<script src="firebase-config.js"></script>

<script>
/* ==========================================================
   VARIABLES GLOBALES
========================================================== */
let productos = [];
let itemsFactura = [];
let isAdmin = false;
let costoEnvio = 0;

// Coordenadas de tu tienda (Prado Oriental, Santo Domingo Este)
const STORE_LAT = 18.4983941;
const STORE_LNG = -69.7898992;
const COSTO_POR_KM = 23; // RD$ por km

function formatearRD(v){
  const n = Number(v)||0;
  return "RD$ " + n.toFixed(2);
}

/* ==========================================================
   GEOLOCALIZACI√ìN Y ENV√çO
========================================================== */
function calcularDistanciaKm(lat1, lon1, lat2, lon2){
  const R = 6371; // km
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function compartirUbicacion(){
  const estado = document.getElementById("estadoEnvio");
  if(!navigator.geolocation){
    estado.textContent = "Tu navegador no soporta compartir ubicaci√≥n.";
    estado.style.color = "#f97373";
    return;
  }

  estado.textContent = "Obteniendo ubicaci√≥n...";
  estado.style.color = "#38bdf8";

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      const distanciaKm = calcularDistanciaKm(STORE_LAT, STORE_LNG, lat, lng);
      costoEnvio = Math.round(distanciaKm * COSTO_POR_KM);

      if(costoEnvio < 0 || !isFinite(costoEnvio)) costoEnvio = 0;

      estado.textContent =
        `Distancia aprox: ${distanciaKm.toFixed(1)} km ‚Ä¢ Env√≠o: ${formatearRD(costoEnvio)}`;
      estado.style.color = "#22c55e";

      actualizarTotales();
    },
    err => {
      console.error(err);
      if(err.code === err.PERMISSION_DENIED){
        estado.textContent = "Debes permitir acceso a tu ubicaci√≥n para calcular el env√≠o.";
      }else{
        estado.textContent = "No se pudo obtener tu ubicaci√≥n. Intenta de nuevo.";
      }
      estado.style.color = "#f97373";
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
  );
}

/* ==========================================================
   CARGAR SETTINGS P√öBLICOS
========================================================== */
async function cargarSettingsPublic(){
  try{
    const doc = await db.collection("settings").doc("principal").get();
    if(doc.exists){
      const d = doc.data();
      document.getElementById("storeNameDisplay").textContent = d.store_name || "Trifusion Technologies";
      document.getElementById("storePhoneDisplay").textContent = d.phone || "829-872-5163";
      document.getElementById("storeAddressDisplay").textContent = d.address || "Autopista de San Isidro";

      if(d.logo){
        const img = document.getElementById("logoFactura");
        img.src = d.logo;
        img.style.display = "block";
      }
    }
  }catch(e){
    console.error("Error settings p√∫blica:", e);
  }
}

/* ==========================================================
   CARGAR PRODUCTOS P√öBLICOS
========================================================== */
async function cargarProductosPublic(){
  try{
    const snap = await db.collection("products").orderBy("createdAt","desc").get();
    productos = [];
    const select = document.getElementById("productoSeleccionado");
    select.innerHTML = "<option value=''>-- Selecciona un producto --</option>";

    snap.forEach(doc=>{
      const d = doc.data();
      const p = {
        id: doc.id,
        name: d.name,
        price: Number(d.price)||0,
        description: d.description || "",
        code: d.code || ""
      };
      productos.push(p);

      const op = document.createElement("option");
      op.value = p.id;
      op.textContent = `${p.name} (RD$ ${p.price.toFixed(2)})`;
      select.appendChild(op);
    });
  }catch(e){
    console.error("Error cargando productos:", e);
  }
}

/* ==========================================================
   AGREGAR PRODUCTOS A LA FACTURA
========================================================== */
function agregarALaFactura(){
  const id  = document.getElementById("productoSeleccionado").value;
  const qty = Number(document.getElementById("cantidadProducto").value);

  if(!id){ alert("Selecciona un producto."); return; }
  if(!qty || qty<=0){ alert("Cantidad inv√°lida."); return; }

  const p = productos.find(x=>x.id===id);
  if(!p) return;

  const existente = itemsFactura.find(i=>i.id===id);
  if(existente){
    existente.quantity += qty;
  }else{
    itemsFactura.push({
      id,
      name: p.name,
      price: p.price,
      quantity: qty
    });
  }

  renderFactura();
  actualizarTotales();
}

function renderFactura(){
  const tbody = document.getElementById("tablaFactura");
  tbody.innerHTML = "";

  if(!itemsFactura.length){
    tbody.innerHTML = `<tr><td colspan="5" class="text-center">No hay productos agregados.</td></tr>`;
    return;
  }

  itemsFactura.forEach((it,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${it.name}</td>
      <td class="text-center">${it.quantity}</td>
      <td class="text-right">${formatearRD(it.price)}</td>
      <td class="text-right">${formatearRD(it.price*it.quantity)}</td>
      <td class="text-right"><button class="btn-danger" onclick="eliminarItem(${idx})">X</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function eliminarItem(i){
  itemsFactura.splice(i,1);
  renderFactura();
  actualizarTotales();
}

/* ==========================================================
   ACTUALIZAR TOTALES
========================================================== */
function actualizarTotales(){
  const subtotal = itemsFactura.reduce((acc,it)=>acc + it.price*it.quantity,0);
  const aplicar  = document.getElementById("aplicarItbis").checked;
  const itbis    = aplicar ? subtotal * 0.18 : 0;
  const total    = subtotal + itbis + costoEnvio;

  document.getElementById("subtotalFactura").textContent = formatearRD(subtotal);
  document.getElementById("itbisFactura").textContent    = formatearRD(itbis);

  const envioSpan1 = document.getElementById("totalEnvio");
  const envioSpan2 = document.getElementById("totalEnvioDetalle");
  if(envioSpan1) envioSpan1.textContent = formatearRD(costoEnvio);
  if(envioSpan2) envioSpan2.textContent = formatearRD(costoEnvio);

  document.getElementById("totalFactura").textContent    = formatearRD(total);
}

/* ==========================================================
   NUEVA FACTURA
========================================================== */
function nuevaFactura(){
  if(!confirm("¬øLimpiar todos los datos?")) return;

  itemsFactura = [];
  costoEnvio = 0;

  renderFactura();
  actualizarTotales();

  document.getElementById("clienteNombre").value = "";
  document.getElementById("clienteDocumento").value = "";
  document.getElementById("clienteTelefono").value = "";
  document.getElementById("clienteDireccion").value = "";
  inicializarFecha();

  document.getElementById("estadoEnvio").textContent = "Esperando ubicaci√≥n...";
  document.getElementById("estadoEnvio").style.color = "#38bdf8";
}

/* ==========================================================
   GUARDAR EN FIRESTORE
========================================================== */
async function guardarEnFirestore(){
  if(!itemsFactura.length){
    alert("No hay productos.");
    return;
  }

  const subtotal = itemsFactura.reduce((acc,it)=>acc + it.price*it.quantity,0);
  const aplica   = document.getElementById("aplicarItbis").checked;
  const itbis    = aplica ? subtotal * 0.18 : 0;
  const total    = subtotal + itbis + costoEnvio;

  const base = {
    client_name: document.getElementById("clienteNombre").value || null,
    document_id: document.getElementById("clienteDocumento").value || null,
    phone:       document.getElementById("clienteTelefono").value || null,
    address:     document.getElementById("clienteDireccion").value || null,
    quote_date:  document.getElementById("fechaFactura").value || null,
    items:       itemsFactura,
    subtotal,
    tax: itbis,
    shipping: costoEnvio,
    total,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    if(isAdmin){
      let num = document.getElementById("facturaNumero").value;
      if(!num){
        num = await obtenerSiguienteNumeroFactura();
        document.getElementById("facturaNumero").value = num;
      }

      const payload = {
        ...base,
        invoiceNumber: num,
        payment_method: document.getElementById("metodoPago").value,
        internal_note: document.getElementById("notaInterna").value || null,
        type: "FACTURA"
      };

      await db.collection("invoices").add(payload);
      alert("Factura guardada como " + num);

    }else{
      const payload = { ...base, type:"COTIZACION" };
      await db.collection("quotes").add(payload);
      alert("Cotizaci√≥n guardada correctamente.");
    }

    cargarQuotesAdmin();

  }catch(e){
    console.error(e);
    alert("Ocurri√≥ un error al guardar.");
  }
}

/* ==========================================================
   FECHA AUTOM√ÅTICA
========================================================== */
function inicializarFecha(){
  const hoy = new Date();
  const yyyy = hoy.getFullYear();
  const mm   = String(hoy.getMonth()+1).padStart(2,"0");
  const dd   = String(hoy.getDate()).padStart(2,"0");
  document.getElementById("fechaFactura").value = `${yyyy}-${mm}-${dd}`;
}

/* ==========================================================
   MODO FACTURA / COTIZACI√ìN
========================================================== */
function activarModoDocumento(admin){
  isAdmin = admin;

  const titulo = document.getElementById("tituloDocumento");
  const modoTexto = document.getElementById("modoTexto");
  const facturaInfo = document.getElementById("facturaInfo");
  const btnGuardar = document.getElementById("btnGuardar");

  if(admin){
    titulo.textContent = "Factura";
    modoTexto.textContent = "FACTURA (administrador)";
    modoTexto.style.color = "#fbbf24";
    facturaInfo.style.display = "block";
    btnGuardar.textContent = "Guardar factura";
    cargarNumeroFactura();

  }else{
    titulo.textContent = "Cotizaci√≥n";
    modoTexto.textContent = "COTIZACI√ìN";
    modoTexto.style.color = "#10b981";
    facturaInfo.style.display = "none";
    btnGuardar.textContent = "Guardar cotizaci√≥n";
    document.getElementById("facturaNumero").value = "";
    document.getElementById("notaInterna").value = "";
  }
}

/* ==========================================================
   N√öMERO DE FACTURA AUTOM√ÅTICO
========================================================== */
async function obtenerSiguienteNumeroFactura(){
  try{
    const snap = await db.collection("invoices")
      .orderBy("createdAt","desc")
      .limit(1)
      .get();

    let next = 1;

    if(!snap.empty){
      const last = snap.docs[0].data();
      if(last.invoiceNumber && /^F-\d{6}$/.test(last.invoiceNumber)){
        const n = parseInt(last.invoiceNumber.slice(2),10);
        if(!isNaN(n)) next = n+1;
      }
    }

    return "F-" + String(next).padStart(6,"0");

  }catch(e){
    console.error("Error n√∫mero factura:", e);
    return "F-000001";
  }
}

async function cargarNumeroFactura(){
  const num = await obtenerSiguienteNumeroFactura();
  document.getElementById("facturaNumero").value = num;
}

/* ==========================================================
   LOGIN / LOGOUT
========================================================== */
async function login(){
  const email = document.getElementById("username").value.trim();
  const pass  = document.getElementById("password").value;

  if(!email || !pass){
    alert("Escribe correo y contrase√±a.");
    return;
  }
  try{
    await auth.signInWithEmailAndPassword(email,pass);

  }catch(e){
    console.error(e);
    alert("Error de inicio de sesi√≥n: " + (e.message || ""));
  }
}

function logout(){
  auth.signOut();
}

auth.onAuthStateChanged(user=>{
  const loginSec = document.getElementById("loginSection");
  const adminSec = document.getElementById("adminSection");
  const lblUser  = document.getElementById("adminUserLabel");

  if(user){
    loginSec.style.display = "none";
    adminSec.style.display = "block";
    lblUser.textContent = user.email;
    lblUser.style.color = "#bbf7d0";

    activarModoDocumento(true);
    cargarTodoAdmin();

  }else{
    loginSec.style.display = "block";
    adminSec.style.display = "none";
    lblUser.textContent = "Invitado";
    lblUser.style.color = "#9ca3af";

    activarModoDocumento(false);
  }
});

/* ==========================================================
   CARGA COMPLETA ADMIN
========================================================== */
async function cargarTodoAdmin(){
  await Promise.all([
    cargarSettingsAdmin(),
    cargarProductosAdmin(),
    cargarQuotesAdmin()
  ]);
}

/* ==========================================================
   SETTINGS ADMIN
========================================================== */
async function cargarSettingsAdmin(){
  try{
    const docSnap = await db.collection("settings").doc("principal").get();

    if(docSnap.exists){
      const d = docSnap.data();

      document.getElementById("storeNameInput").value   = d.store_name || "";
      document.getElementById("storePhoneInput").value  = d.phone || "";
      document.getElementById("storeAddressInput").value= d.address || "";

      if(d.logo){
        const prev = document.getElementById("logoPreview");
        prev.src = d.logo;
        prev.style.display = "block";
        prev.dataset.base64 = d.logo;
      }
    }

  }catch(e){
    console.error("Error settings admin:", e);
  }
}

function handleLogoUpload(ev){
  const file = ev.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e=>{
    const img = document.getElementById("logoPreview");
    img.src = e.target.result;
    img.style.display = "block";
    img.dataset.base64 = e.target.result;
  };
  reader.readAsDataURL(file);
}

async function guardarSettings(){
  const nombre  = document.getElementById("storeNameInput").value.trim();
  const phone   = document.getElementById("storePhoneInput").value.trim();
  const address = document.getElementById("storeAddressInput").value.trim();
  const prev    = document.getElementById("logoPreview");
  const logo64  = prev.dataset.base64 || null;

  try{
    await db.collection("settings").doc("principal").set({
      store_name: nombre  || "Trifusion Technologies",
      phone:      phone   || "829-872-5163",
      address:    address || "Autopista de San Isidro",
      logo:       logo64,
      updatedAt:  firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    alert("Datos de tienda guardados.");
    cargarSettingsPublic();

  }catch(e){
    console.error(e);
    alert("Error al guardar los datos de la tienda.");
  }
}

/* ==========================================================
   ADMIN ‚Äì PRODUCTOS
========================================================== */
async function cargarProductosAdmin(){
  try{
    const snap = await db.collection("products")
      .orderBy("createdAt","desc")
      .get();

    const tbody = document.getElementById("tablaProductos");
    const select = document.getElementById("productoSeleccionado");
    tbody.innerHTML = "";
    select.innerHTML = "<option value=''>-- Selecciona un producto --</option>";

    productos = [];

    snap.forEach(doc=>{
      const d = doc.data();
      const p = {
        id: doc.id,
        name: d.name,
        price: Number(d.price)||0,
        code: d.code || "",
        description: d.description || ""
      };

      productos.push(p);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.name}</td>
        <td class="text-right">RD$ ${p.price.toFixed(2)}</td>
        <td class="text-center">${p.code}</td>
        <td class="text-right">
          <button class="btn-danger" onclick="borrarProducto('${doc.id}')">X</button>
        </td>
      `;
      tbody.appendChild(tr);

      const op = document.createElement("option");
      op.value = p.id;
      op.textContent = `${p.name} (RD$ ${p.price.toFixed(2)})`;
      select.appendChild(op);
    });

  }catch(e){
    console.error("Error productos admin:", e);
  }
}

async function borrarProducto(id){
  if(!confirm("¬øEliminar este producto?")) return;

  try{
    await db.collection("products").doc(id).delete();
    cargarProductosAdmin();

  }catch(e){
    console.error(e);
    alert("Error al eliminar producto.");
  }
}

/* ==========================================================
   ADMIN ‚Äì EXCEL
========================================================== */
function procesarExcel(ev){
  const file = ev.target.files[0];
  if(!file) return;

  const status = document.getElementById("excelStatus");
  status.textContent = "Procesando archivo...";

  const reader = new FileReader();
  reader.onload = e=>{
    const data   = new Uint8Array(e.target.result);
    const wb     = XLSX.read(data,{type:"array"});
    const sheet  = wb.Sheets[wb.SheetNames[0]];
    const rows   = XLSX.utils.sheet_to_json(sheet,{defval:""});

    const lista  = [];

    rows.forEach(r=>{
      const nombre = r.nombre || r.Nombre || r.NOMBRE || "";
      const precioR= r.precio || r.Precio || r.PRECIO || "";
      const desc   = r.descripcion || r.Descripcion || r.DESCRIPCION || "";
      const codigo = r.codigo || r.Codigo || r.C√ìDIGO || "";

      const price = parseFloat(String(precioR).toString().replace(",","."));        

      if(nombre && !isNaN(price)){
        lista.push({
          name:nombre,
          price:price,
          description:desc,
          code:codigo
        });
      }
    });

    if(!lista.length){
      status.textContent = "No se encontraron filas v√°lidas.";
      return;
    }

    enviarBulkProductos(lista);
  };
  reader.readAsArrayBuffer(file);
}

async function enviarBulkProductos(lista){
  const status = document.getElementById("excelStatus");

  try{
    const batch = db.batch();

    lista.forEach(p=>{
      const ref = db.collection("products").doc();
      batch.set(ref,{
        name:p.name,
        price:p.price,
        description:p.description || "",
        code:p.code || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    await batch.commit();
    status.textContent = `Se agregaron ${lista.length} productos.`;

    cargarProductosAdmin();

  }catch(e){
    console.error(e);
    status.textContent = "Error al guardar productos.";
  }
}

/* ==========================================================
   ADMIN ‚Äì COTIZACIONES Y FACTURAS RECIENTES
========================================================== */
async function cargarQuotesAdmin(){
  try{
    const quotesSnap   = await db.collection("quotes")
      .orderBy("createdAt","desc")
      .limit(20)
      .get();

    const invoicesSnap = await db.collection("invoices")
      .orderBy("createdAt","desc")
      .limit(20)
      .get();

    const tbody = document.getElementById("tablaQuotes");
    tbody.innerHTML = "";

    quotesSnap.forEach(doc=>{
      const d = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.client_name || ""}</td>
        <td>COT</td>
        <td class="text-right">RD$ ${(d.total||0).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });

    invoicesSnap.forEach(doc=>{
      const d = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.client_name || ""}</td>
        <td>${d.invoiceNumber || "FAC"}</td>
        <td class="text-right">RD$ ${(d.total||0).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });

  }catch(e){
    console.error("Error cargando cotizaciones:", e);
  }
}

/* ==========================================================
   INICIO DEL SISTEMA
========================================================== */
window.addEventListener("DOMContentLoaded",()=>{
  inicializarFecha();
  cargarSettingsPublic();
  cargarProductosPublic();
  activarModoDocumento(false);
  renderFactura();
  actualizarTotales();
});

/* ============================================================
   üîç BUSCADOR GLOBAL SIN ALTERAR EL SISTEMA ORIGINAL
=========================================================== */
function normalizar(t){
  return t.toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z0-9 ]/g,"");
}

document.getElementById("buscadorGlobal").addEventListener("input", ()=>{
  const q = normalizar(document.getElementById("buscadorGlobal").value.trim());
  const box = document.getElementById("resultadosBusqueda");

  if(!q){
    box.style.display="none";
    box.innerHTML="";
    return;
  }

  const palabras = q.split(" ");
  const marcas = ["hp","epson","canon","jbl","myo","zebra","brother","lenovo","dell"];

  const resultados = productos.filter(p=>{
    const name = normalizar(p.name || "");
    const code = normalizar(p.code || "");

    const matchMarca = marcas.some(m => name.includes(m));

    return (
      name.includes(q) ||
      palabras.every(w => name.includes(w)) ||
      code.includes(q) ||
      (matchMarca && palabras.some(w=>name.includes(w)))
    );
  });

  box.innerHTML="";
  box.style.display="block";

  resultados.slice(0,20).forEach(p=>{
    const item=document.createElement("div");
    item.style.padding="10px";
    item.style.cursor="pointer";
    item.style.borderBottom="1px solid #1f2937";
    item.innerHTML = `<strong>${p.name}</strong><br><span style="color:#10b981;">RD$ ${p.price}</span>`;
    item.onclick=()=>{
      document.getElementById("productoSeleccionado").value = p.id;
      box.style.display="none";
    };
    box.appendChild(item);
  });
});

</script>

</body>
</html>
